# Keyspace Notifications

생성일: 2022년 12월 11일 오후 4:37

> Redis 키 및 값의 변경사항을 실시간으로 모니터링
> 
- keyspace알림을 통해 클라이언트는 Redis 데이터 세트에 영향을 미치는 이벤트를 수신하기 위해 Pub/Sub 채널을 구독 가능
- 예
    - 주어진 키에 영향을 미치는 모든 command
    - LPUSH 작업을 수신하는 모든 키
    - 데이터베이스 0에서 만료되는 모든 키
- 참고: Pub/Sub 클라이언트와 연결이 끊어지면, 끊어진 시간동안 모든 이벤트가 손실된다.

## Type of events

- 모든 작업에 대해 두가지 유형이 이벤트 유형이 있음.
- 예: 데이터 베이스 0에서 mykey라는 키를 대상으로 하는 DEL작업은 다음 두 PUBLISH 명령과 정확히 동일한 두 메시지 전달을 트리거함
    
    ```bash
    PUBLISH __keyspace@0__:mykey del
    PUBLISH __keyevent@0__:del mykey
    ```
    
    - 첫 번째 채널은 mykey를 대상으로 하는 모든 이벤트 수신
    - 다른 채널은 mykey의 del작업만 수신
- Key-space notification: 채널에 키스페이스 접두어가 있는 첫 번째 종류의 이벤트
    - 이벤트의 이름을 메시지로 받음
- Key-evnet notification: 키 이벤트 접두어가 있는 두 번째 이벤트
    - 키의 이름을 메시지로 받음
- 관심있는 이벤트의 하위 집한만 전달하기 위해 한 종류의 알림만 활성화 시킬 수 있음

## Configuration

- default: keyspace event notification은 비활성화
    - 약간의 CPU성능을 사용하기 때문
    - redis.conf의 notify-keyspace-events를 사용하거나 CONFIG SET 명령을 통해 활성화 됨
- 매개변수를 빈 문자열로 설정하면 알림이 비활성화 됨
    - 매개변수에 다음 문자를 넣으면 활성화 됨
        
        ```bash
        K     Keyspace events, published with __keyspace@<db>__ prefix.
        E     Keyevent events, published with __keyevent@<db>__ prefix.
        g     Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ...
        $     String commands
        l     List commands
        s     Set commands
        h     Hash commands
        z     Sorted set commands
        t     Stream commands
        d     Module key type events
        x     Expired events (events generated every time a key expires)
        e     Evicted events (events generated when a key is evicted for maxmemory)
        m     Key miss events (events generated when a key that doesn't exist is accessed)
        n     New key events (Note: not included in the 'A' class)
        A     Alias for "g$lshztxed", so that the "AKE" string means all the events except "m" and "n".
        ```
        
    - 최소한 K 또는 E가 문자열에 있어야한다. 그렇지 않으면 이벤트 전달되지 않음
        - ex)
            - Kl: 목록에 대한 키 공간 이벤트만 활성화
            - KEA: 대부분의 이벤트 유형 활성화

## ****Events generated by different commands****

[상세 참조](https://redis.io/docs/manual/keyspace-notifications/)

- 모든 명령은 키가 수정된 경우에만 이벤트 생성
- 이벤트 생성이 의심스러운 경우 스스로 관찰해야한다.

## Timing of expired events

- TTL이 연결된 키는 두 가지 방법으로 만료됨
    - 키가 명령에 의해 액세스되고 만료된 경우
    - 액세스하지 않는 키도 수집할 수 있도록 백그라운드에서 만료된 키를 찾는 시스템을 통해
- 서버가 TTL에 만료된 이벤트를 생성할 수 있다는 보장이 없다. (0에 수렴한다)
- 이론적으로 TTL이 0이 될때는 이벤트를 생성하지 않는다.

## Events in a cluster

- 클러스터의 모든 노드는 자체 키스페이스 하위 집합에 대한 이벤트를 생성함
- Pub/Sub 방식과는 달리 이벤트 알림이 모든 노드에 broadcast되지는 않는다.
- 클러스터의 모든 키스페이스 이벤트를 수신하려면 클라이언트가 각 노드에 가입해야한다.